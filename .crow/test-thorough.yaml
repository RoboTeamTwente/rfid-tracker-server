# yaml-language-server: $schema=https://raw.githubusercontent.com/woodpecker-ci/woodpecker/main/pipeline/frontend/yaml/linter/schema/schema.json

when:
  - event: pull_request

steps:
  setup:
    image: nixos/nix
    volumes:
      - crow-rtt-nix:/nix
    commands:
      - echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
      - echo 'max-jobs = auto' >> /etc/nix/nix.conf
      - nix develop -Lc uv sync --locked --no-progress

  pre-commit:
    image: nixos/nix
    volumes:
      - crow-rtt-nix:/nix
    depends_on: setup
    environment:
      CI: 1 # for //repo/dotfiles/lefthook
    commands:
      - nix develop -Lc lefthook run --all-files --force pre-commit

  build-container:
    image: nixos/nix
    volumes:
      - crow-rtt-nix:/nix
    depends_on: setup
    commands:
      - nix develop -Lc std //repo/containers/prod-latest:build
