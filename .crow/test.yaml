when:
  - event: [push, pull_request]
    branch: main
  - event: push
    branch: renovate/*

steps:
  fast:
    image: ghcr.io/astral-sh/uv:debian
    directory: door_tracker
    commands:
      - uv sync --locked --no-progress
      - uv run manage.py test --noinput
  thorough:
    image: nixos/nix
    volumes:
      - crow-rtt-nix:/nix
    environment:
      CI: 1 # for //repo/dotfiles/lefthook
    commands:
      - echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
      - nix develop -Lc uv sync --locked --no-progress
      - nix develop -Lc just check
